<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockDigest - Tin Chứng Khoán AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container py-5">
    <h1 class="text-center text-white mb-4 text-shadow">StockDigest</h1>
    <p class="text-center text-white mb-5 fs-4">Tin chứng khoán tóm tắt bằng AI</p>

    <div class="card mb-5 shadow-lg">
        <div class="card-body">
            <div class="input-group input-group-lg mb-3">
                <input type="text" id="codes" class="form-control fs-5" placeholder="VD: VCB HPG FPT USD FTSE">
                <button class="btn btn-danger btn-lg px-5" onclick="save()">Theo dõi ngay</button>
            </div>
            <p class="mb-0 fs-5"><strong>Đang theo dõi:</strong>
                <span id="list" class="text-danger fw-bold">Chưa có mã nào</span>
            </p>
        </div>
    </div>

    <div id="news" class="row row-cols-1 g-4"></div>

    <div id="alert" class="alert alert-danger text-center fixed-top d-none shadow-lg"
         style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
        <h4 class="mb-0">TIN NÓNG VỪA CÓ!</h4>
    </div>
</div>

<script>
function save() {
    const input = document.getElementById('codes').value.trim().toUpperCase();
    if (!input) return;
    const codes = input.split(/\s+/).filter(Boolean);
    localStorage.setItem('watch', JSON.stringify(codes));
    document.getElementById('list').textContent = codes.join(', ') || 'Chưa có mã nào';
    load();
}

function load() {
    const watchlist = JSON.parse(localStorage.getItem('watch') || '[]');
    document.getElementById('list').textContent = watchlist.length ? watchlist.join(', ') : 'Chưa có mã nào';

    fetch('/api/news?watch=' + encodeURIComponent(JSON.stringify(watchlist)))
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('news');
            container.innerHTML = '';
            let hasNew = false;

            data.forEach(item => {
                if (item.is_hot) hasNew = true;

                const card = document.createElement('div');
                card.className = 'col';
                card.innerHTML = `
                    <div class="card h-100 shadow-lg ${item.is_hot ? 'border-danger border-5' : ''}">
                        <div class="card-body d-flex flex-column">
                            ${item.is_hot ? '<h3 class="text-danger fw-bold mb-3">TIN NÓNG CHO BẠN!</h3>' : ''}
                            <h5 class="card-title">${item.title}</h5>
                            <p class="card-text flex-grow-1">${item.summary.replace(/\n/g, '<br>')}</p>
                            <div class="mt-auto d-flex justify-content-between align-items-end">
                                <a href="${item.url}" target="_blank" class="btn btn-${item.is_hot ? 'danger' : 'primary'} btn-lg">
                                    ${item.is_hot ? 'ĐỌC NGAY' : 'Xem thêm'}
                                </a>
                                <div class="text-end">
                                    <small class="text-muted d-block">Mã liên quan:</small>
                                    ${item.codes.map(code =>
                                        item.matched_codes.includes(code)
                                            ? `<span class="badge bg-danger text-white fs-6 mx-1 px-3 py-2">${code}</span>`
                                            : `<span class="badge bg-secondary text-white mx-1">${code}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (hasNew) {
                document.getElementById('alert').classList.remove('d-none');
                setTimeout(() => document.getElementById('alert').classList.add('d-none'), 7000);
            }
        })
        .catch(err => {
            console.error('Lỗi API:', err);
            document.getElementById('news').innerHTML = '<p class="text-center text-danger">Lỗi tải tin, đang thử lại...</p>';
        });
}

setInterval(load, 40000);
load();
</script>
</body>
</html>